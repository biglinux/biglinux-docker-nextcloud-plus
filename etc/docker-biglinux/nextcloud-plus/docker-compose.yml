version: '3.9'

services:
    nextcloud_db:
        image: postgres:13-alpine
        container_name: nextcloud_db
        restart: always
        volumes:
            - ${HOME}/Docker/Nextcloud-Plus/db:/var/lib/postgresql/data
        environment:
            - POSTGRES_PASSWORD=b1gl1nux@db
            - POSTGRES_DB=nextcloud
            - POSTGRES_USER=nextcloud
        networks:
            big-net:

    nextcloud:
        image: nextcloud:stable
        container_name: nextcloud
        restart: always
        volumes:
            - ${HOME}/Docker/Nextcloud-Plus/nextcloud:/var/www/html
            #- ${HOME}/Docker/Nextcloud-Plus/nextcloud/opcache-recommended.ini:/usr/local/etc/php/conf.d/opcache-recommended.ini
        environment:
            - POSTGRES_HOST=nextcloud_db
            - REDIS_HOST_PASSWORD=b1gl1nux@redis
            - POSTGRES_PASSWORD=b1gl1nux@db
            - POSTGRES_DB=nextcloud
            - POSTGRES_USER=nextcloud
        depends_on:
            - nextcloud_db
            - redis
        ports:
            - "8286:80/tcp"
        networks:
            big-net:

    redis:
        image: redis:alpine
        container_name: redis
        restart: unless-stopped
        command: redis-server --requirepass b1gl1nux@redis --appendonly yes
        volumes:
            - ${HOME}/Docker/Nextcloud-Plus/redis:/data
        deploy:
            resources:
                limits:
                    # Limits the CPU usage by the container to 4 cores.
                    cpus: '4'
                    # Limits the memory usage by the container to 4GB.
                    memory: 4G
        healthcheck:
            # Checks the health of the container using curl to access port 8200.
            test: ["CMD", "curl", "-f", "http://127.0.0.1:8200"]
            # The interval between each health check.
            interval: 30s
            # The maximum amount of time a health check can take before it is considered a failure.
            timeout: 10s
            # The number of consecutive health check failures required for the container to be considered unhealthy.
            retries: 6
        # Network the container will be connected to.
        networks:
            big-net:

# Defines the networks that will be created
networks:
    # Network name
    big-net:
        # Name assigned to the network
        name: big-net
